<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TASIS Policy Review Tool</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F1F5F9; min-height: 100vh; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #0F1E33 0%, #1B3A5C 60%, #2C5AA0 100%); padding: 16px 24px; color: #FFF; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 14px; }
    .header img { height: 40px; }
    .header h1 { font-size: 18px; font-weight: 700; }
    .header p { font-size: 11px; opacity: 0.7; margin-top: 2px; }
    .card { background: #FFF; border-radius: 0 0 12px 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .section { padding: 24px; border-bottom: 1px solid #E2E8F0; }
    .section:last-child { border-bottom: none; }
    .section-title { font-size: 12px; font-weight: 700; color: #1B3A5C; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .section-title span { font-size: 16px; }
    
    /* Upload area */
    .upload-zone { border: 2px dashed #CBD5E1; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #1B3A5C; background: #F8FAFC; }
    .upload-zone.has-file { border-color: #059669; background: #F0FDF4; }
    .upload-icon { font-size: 36px; margin-bottom: 10px; }
    .upload-text { font-size: 14px; color: #64748B; }
    .upload-text strong { color: #1B3A5C; }
    .file-info { margin-top: 12px; padding: 10px 16px; background: #FFF; border-radius: 6px; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 600; color: #065F46; }
    
    /* Form elements */
    label { display: block; font-size: 12px; font-weight: 600; color: #475569; margin-bottom: 6px; }
    select, textarea, input[type="text"], input[type="password"] { width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
    select:focus, textarea:focus, input:focus { outline: none; border-color: #1B3A5C; }
    textarea { resize: vertical; min-height: 100px; font-family: inherit; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .hint { font-size: 11px; color: #94A3B8; margin-top: 4px; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: #1B3A5C; color: #FFF; }
    .btn-primary:hover { background: #0F1E33; }
    .btn-primary:disabled { background: #94A3B8; cursor: not-allowed; }
    .btn-success { background: #059669; color: #FFF; }
    .btn-success:hover { background: #047857; }
    .btn-outline { background: #FFF; color: #1B3A5C; border: 1px solid #E2E8F0; }
    .btn-outline:hover { background: #F8FAFC; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    
    /* Results */
    .results { background: #F8FAFC; border-radius: 8px; padding: 16px; }
    .result-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #E2E8F0; font-size: 13px; line-height: 1.5; }
    .result-item:last-child { border-bottom: none; }
    .result-icon { font-size: 16px; flex-shrink: 0; }
    .result-pass { color: #059669; }
    .result-fail { color: #DC2626; }
    .result-warn { color: #D97706; }
    .result-info { color: #2563EB; }
    
    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 40px; color: #64748B; }
    .spinner { width: 24px; height: 24px; border: 3px solid #E2E8F0; border-top-color: #1B3A5C; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Settings toggle */
    .settings-toggle { position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: none; color: #FFF; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    .settings-panel { background: #FFF; border: 1px solid #E2E8F0; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
    
    /* Summary stats */
    .summary-bar { display: flex; gap: 16px; margin-bottom: 16px; }
    .summary-stat { flex: 1; padding: 12px; border-radius: 8px; text-align: center; }
    .summary-stat.pass { background: #D1FAE5; color: #065F46; }
    .summary-stat.fail { background: #FEE2E2; color: #991B1B; }
    .summary-stat.warn { background: #FEF3C7; color: #92400E; }
    .summary-num { font-size: 24px; font-weight: 700; }
    .summary-label { font-size: 11px; text-transform: uppercase; }
    
    /* Preset chips */
    .preset-requirements { background: #F0F5FF; border-radius: 6px; padding: 12px; margin-bottom: 12px; font-size: 12px; color: #1E40AF; }
    .preset-requirements strong { display: block; margin-bottom: 6px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
const { useState, useRef, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POLICY TYPE PRESETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const POLICY_PRESETS = {
  "safeguarding": {
    name: "Safeguarding & Child Protection",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference KCSIE 2025 (not older versions)
- Must reference Working Together 2023
- Must include DSL contact details (Jason Tait)
- Must define types of abuse (physical, emotional, sexual, neglect)
- Must include procedures for reporting concerns
- Must reference local safeguarding partnership (Surrey)
- Must address child-on-child abuse
- Must include online safety provisions
- Must reference RESPOND framework
- Must include staff training requirements
- Must have clear escalation procedures
- Must address children with SEND
- Must include information sharing protocols`
  },
  "boarding": {
    name: "Boarding",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference National Minimum Standards for Boarding 2022
- Must include welfare provisions
- Must address supervision ratios
- Must include contact arrangements with parents
- Must address health and medical needs
- Must include safeguarding procedures specific to boarding
- Must reference KCSIE 2025
- Must address overnight supervision
- Must include fire safety procedures
- Must address missing boarder procedures`
  },
  "behaviour": {
    name: "Behaviour & Discipline",
    requirements: `MANDATORY REQUIREMENTS:
- Must be consistent with Equality Act 2010
- Must include rewards and sanctions
- Must address bullying (including cyber-bullying)
- Must reference exclusion procedures
- Must address reasonable force/restraint
- Must include searching and confiscation
- Must address SEND considerations
- Must include pastoral support
- Must reference anti-bullying policy`
  },
  "health_safety": {
    name: "Health & Safety",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference Health and Safety at Work Act 1974
- Must include risk assessment procedures
- Must address first aid provisions
- Must include fire safety procedures
- Must address educational visits
- Must include accident reporting (RIDDOR)
- Must address lone working
- Must include emergency procedures
- Must address contractor management`
  },
  "hr": {
    name: "HR / Staff",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference safer recruitment procedures
- Must include DBS check requirements
- Must address staff code of conduct
- Must include whistleblowing procedures
- Must reference Disqualification under Childcare Act
- Must address allegations against staff
- Must include supervision and appraisal
- Must reference single central record
- Must address overseas checks for international staff`
  },
  "admissions": {
    name: "Admissions",
    requirements: `MANDATORY REQUIREMENTS:
- Must be non-discriminatory (Equality Act 2010)
- Must include SEND admissions procedures
- Must address EAL considerations
- Must include entry requirements
- Must address scholarship/bursary provisions
- Must include appeals process`
  },
  "send": {
    name: "SEND",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference SEND Code of Practice 2015
- Must include graduated approach (assess, plan, do, review)
- Must address SENCO responsibilities
- Must include identification procedures
- Must address reasonable adjustments
- Must include EHCP procedures
- Must address transition arrangements
- Must reference Equality Act 2010`
  },
  "curriculum": {
    name: "Curriculum",
    requirements: `MANDATORY REQUIREMENTS:
- Must meet Independent School Standards Part 1
- Must include PSHE/RSE requirements
- Must address British values
- Must include assessment and reporting
- Must address differentiation
- Must include careers education (Gatsby benchmarks)
- Must reference Relationships Education statutory guidance`
  },
  "complaints": {
    name: "Complaints",
    requirements: `MANDATORY REQUIREMENTS:
- Must include informal and formal stages
- Must specify timeframes at each stage
- Must include panel hearing procedures
- Must address record keeping
- Must include ISI reporting requirements
- Must address confidentiality
- Must include appeals process`
  },
  "data_protection": {
    name: "Data Protection / Privacy",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference UK GDPR and Data Protection Act 2018
- Must include lawful bases for processing
- Must address data subject rights
- Must include retention schedules
- Must address data breaches
- Must include DPO contact details
- Must address international transfers
- Must include privacy notices`
  },
  "custom": {
    name: "Custom / Other",
    requirements: ""
  }
};

const TASIS_TEMPLATE_CHECKS = [
  { id: "safeguarding_stmt", label: "Safeguarding commitment statement", required: true },
  { id: "scope_stmt", label: "Whole-school scope statement (including Boarding/EYFS)", required: true },
  { id: "version_stmt", label: "Current version statement", required: true },
  { id: "metadata", label: "Metadata table (7 fields)", required: true },
  { id: "signatory", label: "Signatory block (Head of School, Chair)", required: true },
  { id: "numbered_sections", label: "Numbered sections", required: true },
  { id: "review_date", label: "Review/update date specified", required: true },
  { id: "responsible", label: "Responsible area/person identified", required: true },
  { id: "legislation_refs", label: "Legislation references current", required: false },
  { id: "respond_ref", label: "RESPOND framework referenced (if safeguarding-related)", required: false },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN COMPONENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function PolicyReviewTool() {
  // State
  const [apiKey, setApiKey] = useState(localStorage.getItem('tasis_api_key') || '');
  const [showSettings, setShowSettings] = useState(!localStorage.getItem('tasis_api_key'));
  const [file, setFile] = useState(null);
  const [fileText, setFileText] = useState('');
  const [policyType, setPolicyType] = useState('safeguarding');
  const [customRequirements, setCustomRequirements] = useState('');
  const [loading, setLoading] = useState(false);
  const [results, setResults] = useState(null);
  const [restructured, setRestructured] = useState(null);
  const [restructuring, setRestructuring] = useState(false);
  const fileInputRef = useRef(null);

  // Save API key
  const saveApiKey = () => {
    localStorage.setItem('tasis_api_key', apiKey);
    setShowSettings(false);
  };

  // File handling
  const handleFile = async (f) => {
    setFile(f);
    setResults(null);
    setRestructured(null);
    
    try {
      let text = '';
      const ext = f.name.split('.').pop().toLowerCase();
      
      if (ext === 'txt' || ext === 'md') {
        text = await f.text();
      } else if (ext === 'docx') {
        const arrayBuffer = await f.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        text = result.value;
      } else if (ext === 'pdf') {
        const arrayBuffer = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const pages = [];
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          pages.push(content.items.map(item => item.str).join(' '));
        }
        text = pages.join('\n\n');
      }
      
      setFileText(text);
    } catch (e) {
      alert('Error reading file: ' + e.message);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
  };

  // Analyse policy
  const analysePolicy = async () => {
    if (!fileText || !apiKey) return;
    
    setLoading(true);
    setResults(null);
    
    const preset = POLICY_PRESETS[policyType];
    const requirements = preset.requirements + (customRequirements ? '\n\nADDITIONAL REQUIREMENTS:\n' + customRequirements : '');
    
    const systemPrompt = `You are a UK school policy compliance reviewer for TASIS The American School in England.

Your task is to review the uploaded policy document against:
1. The TASIS standard template requirements
2. The specific policy type requirements provided

TASIS TEMPLATE REQUIREMENTS:
- Safeguarding commitment statement at the top
- Scope statement: "This policy applies to the whole school including Boarding and the Early Years"
- Version statement about current version on website
- Metadata table with: Information Sharing Category, Document Reference, Version, Date Published, Date Ratified, Review Date, Responsible Area
- Signatory block with Head of School (Bryan Nixon) and Chair of Board (David King)
- Numbered sections throughout
- Review/update date clearly specified
- RESPOND framework reference for safeguarding-related policies

RESPOND FRAMEWORK: Recognise â†’ Engage â†’ Support â†’ Pause â†’ Offer â†’ Notify â†’ Document
ACT FOUNDATIONS: Active Intervention, Contextual Safeguarding, Trauma-Informed Practice

Respond in JSON format:
{
  "summary": "Brief overall assessment (2-3 sentences)",
  "overallScore": 85,
  "templateChecks": [
    {"id": "safeguarding_stmt", "pass": true, "note": "Present on page 1"},
    {"id": "scope_stmt", "pass": false, "note": "Missing - needs to be added"},
    ...
  ],
  "contentIssues": [
    {"type": "error", "issue": "Missing KCSIE 2025 reference", "location": "Section 3", "suggestion": "Add reference to KCSIE 2025 Part 1"},
    {"type": "warning", "issue": "DSL contact details incomplete", "location": "Page 2", "suggestion": "Add email and phone number"},
    {"type": "info", "issue": "Consider adding flowchart for reporting", "location": "Section 5", "suggestion": "Visual aid would improve clarity"}
  ],
  "missingElements": ["List of elements that should be added"],
  "outdatedReferences": ["Any legislation or guidance that needs updating"],
  "strengthAreas": ["What the policy does well"],
  "priorityActions": ["Top 3-5 actions in order of importance"]
}`;

    const userPrompt = `POLICY TYPE: ${preset.name}

SPECIFIC REQUIREMENTS FOR THIS POLICY:
${requirements}

POLICY DOCUMENT TO REVIEW:
${fileText.substring(0, 80000)}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4000,
          messages: [{ role: 'user', content: userPrompt }],
          system: systemPrompt
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      const text = data.content[0].text;
      
      // Extract JSON from response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        setResults(JSON.parse(jsonMatch[0]));
      } else {
        throw new Error('Could not parse response');
      }
    } catch (e) {
      alert('Error analysing policy: ' + e.message);
    } finally {
      setLoading(false);
    }
  };

  // Restructure policy into TASIS template
  const restructurePolicy = async () => {
    if (!fileText || !apiKey) return;
    
    setRestructuring(true);
    
    const preset = POLICY_PRESETS[policyType];
    
    const systemPrompt = `You are a document formatter for TASIS The American School in England.

Your task is to FORMAT the provided policy document into the TASIS template structure. You are a FORMATTER, not an EDITOR.

CRITICAL RULES:
1. DO NOT reorganize, summarize, reduce, or make editorial decisions
2. DO NOT change the wording or structure of content
3. PRESERVE the exact section structure, numbering, and content from the original
4. ONLY extract metadata and wrap content in the template format

CRITICAL JSON FORMATTING RULES:
- Return ONLY valid JSON - no markdown, no code blocks, no explanatory text
- All strings must have special characters properly escaped:
  - Newlines as \\n
  - Quotes as \\"
  - Backslashes as \\\\
  - Tabs as \\t
- Keep section content as single-line strings (use \\n for line breaks within content)
- Do not include actual line breaks inside JSON string values

OUTPUT FORMAT:
{
  "policyTitle": "Extract exact title from document",
  "shortCode": "Extract from document or use POL",
  "version": "Extract from document",
  "datePublished": "Extract from document",
  "dateRatified": "Extract from document", 
  "reviewDate": "Extract from document",
  "responsibleArea": "Extract from document",
  "infoSharingCategory": "Extract from document or PUBLIC",
  "scope": "Extract from document",
  "legislationReferenced": ["Extract any legislation cited in document"],
  "sections": [
    {
      "number": "Use exact numbering from original document",
      "title": "Use exact section title from original",
      "content": "Use EXACT content from original section - do not modify"
    }
  ],
  "signatories": [
    {"role": "Extract from document", "name": "Extract from document", "date": "Extract from document"}
  ],
  "crossReferences": ["Extract any related policies mentioned"],
  "respondReference": true or false based on whether RESPOND is mentioned
}

FORMATTING RULES:
1. Extract metadata exactly as it appears in the document
2. Preserve the EXACT section structure - same numbers, same titles, same order
3. Preserve ALL content within each section VERBATIM - every word, every bullet point
4. If the document has 22 sections, output 22 sections
5. If content is lengthy, include ALL of it - do not truncate
6. Escape special characters for valid JSON but preserve the actual text
7. You are packaging existing content, not creating or editing it`;

    const userPrompt = `POLICY TYPE: ${preset.name}

FORMAT this policy document into the TASIS template structure. PRESERVE ALL CONTENT EXACTLY AS WRITTEN - do not reorganize, summarize, or edit.

ORIGINAL DOCUMENT:
${fileText.substring(0, 80000)}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 16000,
          messages: [{ role: 'user', content: userPrompt }],
          system: systemPrompt
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      const text = data.content[0].text;
      
      // Extract JSON from response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        let jsonStr = jsonMatch[0];
        
        // Clean JSON - fix common LLM output issues
        const cleanJSON = (str) => {
          // Replace literal newlines inside strings with \n escape
          // This regex finds string values and escapes newlines within them
          let inString = false;
          let escaped = false;
          let result = '';
          
          for (let i = 0; i < str.length; i++) {
            const char = str[i];
            
            if (escaped) {
              result += char;
              escaped = false;
              continue;
            }
            
            if (char === '\\') {
              escaped = true;
              result += char;
              continue;
            }
            
            if (char === '"') {
              inString = !inString;
              result += char;
              continue;
            }
            
            if (inString) {
              // Replace problematic characters inside strings
              if (char === '\n') {
                result += '\\n';
              } else if (char === '\r') {
                result += '\\r';
              } else if (char === '\t') {
                result += '\\t';
              } else if (char.charCodeAt(0) < 32) {
                // Skip other control characters
                result += ' ';
              } else {
                result += char;
              }
            } else {
              result += char;
            }
          }
          return result;
        };
        
        jsonStr = cleanJSON(jsonStr);
        
        try {
          setRestructured(JSON.parse(jsonStr));
        } catch (parseError) {
          console.error('JSON parse error:', parseError.message);
          console.error('Raw JSON (first 500 chars):', jsonStr.substring(0, 500));
          throw new Error('Could not parse AI response. Please try again or use a shorter document.');
        }
      } else {
        throw new Error('Could not find JSON in AI response');
      }
    } catch (e) {
      alert('Error formatting policy: ' + e.message);
    } finally {
      setRestructuring(false);
    }
  };

  // TASIS Brand Colors
  const TASIS_NAVY = [30, 58, 95];      // #1E3A5F
  const TASIS_RED = [200, 16, 46];      // #C8102E
  const TASIS_GREY = [100, 116, 139];
  const TASIS_LIGHT = [248, 250, 252];
  const WHITE = [255, 255, 255];
  const BLACK = [0, 0, 0];

  // Load logo for PDF
  const loadLogoForPDF = () => {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = 'Anonymous';
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = () => resolve(null);
      img.src = 'https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png';
    });
  };

  // Generate formatted policy PDF - matching review report style
  const generateRestructuredPDF = async () => {
    if (!restructured) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    
    const pageWidth = 210;
    const pageHeight = 297;
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    let y = margin;
    
    // Load logo
    const logoData = await loadLogoForPDF();
    
    // Cover page header (page 1 only) - centered logo, prominent title
    const addCoverHeader = () => {
      // Navy header bar - taller for cover
      doc.setFillColor(...TASIS_NAVY);
      doc.rect(0, 0, pageWidth, 50, 'F');
      
      // Red accent line
      doc.setFillColor(...TASIS_RED);
      doc.rect(0, 50, pageWidth, 2, 'F');
      
      // Centered logo
      if (logoData) {
        doc.addImage(logoData, 'PNG', pageWidth/2 - 12, 5, 24, 24);
      }
      
      // Policy title below logo
      doc.setTextColor(...WHITE);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      const titleLines = doc.splitTextToSize(restructured.policyTitle || 'Policy Document', contentWidth - 20);
      doc.text(titleLines, pageWidth / 2, 38, { align: 'center' });
      
      // Version/date on right
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text(`${restructured.shortCode || 'POL'} v${restructured.version || '1.0'}`, pageWidth - margin, 46, { align: 'right' });
    };

    // Running header (page 2+) - small logo, compact
    const addHeader = () => {
      // Navy header bar
      doc.setFillColor(...TASIS_NAVY);
      doc.rect(0, 0, pageWidth, 28, 'F');
      
      // Red accent line
      doc.setFillColor(...TASIS_RED);
      doc.rect(0, 28, pageWidth, 2, 'F');
      
      // Logo in header
      if (logoData) {
        doc.addImage(logoData, 'PNG', margin, 4, 20, 20);
      }
      
      // Header text - just title and version
      doc.setTextColor(...WHITE);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      const shortTitle = (restructured.policyTitle || 'Policy Document').substring(0, 60);
      doc.text(shortTitle, logoData ? margin + 25 : margin, 12);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text(`${restructured.shortCode || 'POL'} v${restructured.version || '1.0'}`, logoData ? margin + 25 : margin, 20);
      
      // Date on right
      doc.setFontSize(9);
      doc.text(restructured.datePublished || '', pageWidth - margin, 16, { align: 'right' });
    };
    
    const addFooter = (pageNum, totalPages) => {
      // Footer line
      doc.setDrawColor(...TASIS_NAVY);
      doc.setLineWidth(0.3);
      doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
      
      // Red accent
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, pageHeight - 14.5, margin + 25, pageHeight - 14.5);
      
      doc.setFontSize(7);
      doc.setTextColor(...TASIS_GREY);
      doc.text('TASIS England is committed to safeguarding and promoting the welfare of students...', margin, pageHeight - 10);
      doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
      doc.text(`${restructured.shortCode || 'POL'}_v${restructured.version || '1.0'}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    };
    
    const addPage = () => {
      doc.addPage();
      addHeader();
      y = 48;
    };
    
    const checkPageBreak = (needed) => {
      if (y + needed > pageHeight - 25) {
        addPage();
      }
    };

    // â•â•â• PAGE 1: Cover/Metadata â•â•â•
    addCoverHeader();
    y = 65;  // Start after cover header
    
    // Safeguarding statement box
    doc.setFillColor(...TASIS_LIGHT);
    doc.roundedRect(margin, y, contentWidth, 18, 2, 2, 'F');
    doc.setDrawColor(...TASIS_NAVY);
    doc.setLineWidth(0.3);
    doc.roundedRect(margin, y, contentWidth, 18, 2, 2, 'S');
    doc.setTextColor(...TASIS_NAVY);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'italic');
    const safeguardingStmt = 'TASIS England is committed to safeguarding and promoting the welfare of students and expects all faculty, staff and volunteers to share this commitment. It is our aim that all students fulfil their potential.';
    const stmtLines = doc.splitTextToSize(safeguardingStmt, contentWidth - 8);
    doc.text(stmtLines, margin + 4, y + 6);
    y += 24;
    
    // Scope statement
    doc.setTextColor(...TASIS_GREY);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text(`This policy applies to the whole school including ${restructured.scope || 'Boarding and the Early Years'}.`, margin, y);
    y += 10;
    
    // Metadata section header
    doc.setTextColor(...TASIS_NAVY);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Document Information', margin, y);
    doc.setDrawColor(...TASIS_RED);
    doc.setLineWidth(0.8);
    doc.line(margin, y + 2, margin + 45, y + 2);
    y += 8;
    
    // Metadata table - compact style
    const metaData = [
      ['Document Reference', `TASIS_${restructured.shortCode || 'POL'}_v${restructured.version || '1.0'}`],
      ['Version', `v${restructured.version || '1.0'}`],
      ['Published', restructured.datePublished || ''],
      ['Ratified', restructured.dateRatified || ''],
      ['Review Date', restructured.reviewDate || ''],
      ['Owner', restructured.responsibleArea || ''],
      ['Classification', restructured.infoSharingCategory || 'PUBLIC']
    ];
    
    doc.setFontSize(9);
    metaData.forEach(row => {
      doc.setTextColor(...TASIS_NAVY);
      doc.setFont('helvetica', 'bold');
      doc.text(row[0] + ':', margin, y);
      doc.setTextColor(...BLACK);
      doc.setFont('helvetica', 'normal');
      doc.text(row[1], margin + 40, y);
      y += 5;
    });
    
    y += 8;
    
    // Signatories section
    doc.setTextColor(...TASIS_NAVY);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Approved By', margin, y);
    doc.setDrawColor(...TASIS_RED);
    doc.setLineWidth(0.8);
    doc.line(margin, y + 2, margin + 30, y + 2);
    y += 8;
    
    const sigs = restructured.signatories || [
      { role: 'Head of School', name: 'Bryan Nixon', date: '' },
      { role: 'Chair of Board', name: 'David King', date: '' }
    ];
    
    doc.setFontSize(9);
    sigs.forEach(sig => {
      doc.setTextColor(...TASIS_NAVY);
      doc.setFont('helvetica', 'bold');
      doc.text(sig.role + ':', margin, y);
      doc.setTextColor(...BLACK);
      doc.setFont('helvetica', 'normal');
      doc.text(`${sig.name || ''} (${sig.date || ''})`, margin + 45, y);
      y += 5;
    });
    
    y += 8;
    
    // Legislation references
    if (restructured.legislationReferenced?.length > 0) {
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text('Statutory Compliance', margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 2, margin + 42, y + 2);
      y += 8;
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...BLACK);
      const legText = restructured.legislationReferenced.join('; ');
      const legLines = doc.splitTextToSize(legText, contentWidth);
      doc.text(legLines, margin, y);
      y += legLines.length * 4 + 5;
    }
    
    // Contents section
    if (restructured.sections?.length > 0) {
      y += 5;
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text('Contents', margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 2, margin + 22, y + 2);
      y += 8;
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...BLACK);
      
      restructured.sections.forEach(section => {
        if (y > pageHeight - 30) {
          addPage();
        }
        doc.text(`${section.number}. ${section.title}`, margin + 3, y);
        y += 5;
      });
    }
    
    // â•â•â• CONTENT PAGES â•â•â•
    addPage();
    
    (restructured.sections || []).forEach((section, idx) => {
      checkPageBreak(15);
      
      // Section header - matching review report style
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text(`${section.number}. ${section.title}`, margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      const titleWidth = doc.getTextWidth(`${section.number}. ${section.title}`);
      doc.line(margin, y + 2, margin + Math.min(titleWidth, 60), y + 2);
      y += 8;
      
      // Section content
      doc.setTextColor(...BLACK);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      
      const content = (section.content || '').replace(/\\n/g, '\n');
      const contentLines = doc.splitTextToSize(content, contentWidth);
      
      contentLines.forEach(line => {
        checkPageBreak(5);
        doc.text(line, margin, y);
        y += 4.5;
      });
      
      y += 6;
    });
    
    // Cross-references
    if (restructured.crossReferences?.length > 0) {
      checkPageBreak(15);
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('Related Policies', margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 2, margin + 35, y + 2);
      y += 7;
      
      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...BLACK);
      doc.text(restructured.crossReferences.join('; '), margin, y);
      y += 10;
    }
    
    // RESPOND framework box
    if (restructured.respondReference) {
      checkPageBreak(20);
      doc.setFillColor(209, 250, 229);
      doc.roundedRect(margin, y, contentWidth, 16, 2, 2, 'F');
      doc.setDrawColor(5, 150, 105);
      doc.setLineWidth(0.5);
      doc.roundedRect(margin, y, contentWidth, 16, 2, 2, 'S');
      doc.setTextColor(6, 95, 70);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('RESPOND Framework', margin + 4, y + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text('Recognise â†’ Engage â†’ Support â†’ Pause â†’ Offer â†’ Notify â†’ Document', margin + 4, y + 11);
    }
    
    // Add footers to all pages
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      addFooter(i, pageCount);
    }
    
    // Save
    const filename = `${(restructured.policyTitle || 'Policy').replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_')}_TASIS_v${restructured.version || '1.0'}.pdf`;
    doc.save(filename);
  };

  // Generate review report PDF
  const generatePDF = async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });

    const pageWidth = 210;
    const pageHeight = 297;
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    let y = margin;

    // Load logo
    const logoData = await loadLogoForPDF();

    // Header
    doc.setFillColor(...TASIS_NAVY);
    doc.rect(0, 0, pageWidth, 32, 'F');
    
    // Red accent line
    doc.setFillColor(...TASIS_RED);
    doc.rect(0, 32, pageWidth, 2, 'F');
    
    // Logo in header
    if (logoData) {
      doc.addImage(logoData, 'PNG', margin, 6, 20, 20);
    }
    
    // Header text - just title and date (school name is in logo)
    doc.setTextColor(...WHITE);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('Policy Review Report', logoData ? margin + 25 : margin, 18);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text(new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }), pageWidth - margin, 18, { align: 'right' });

    y = 48;

    // Policy info
    doc.setTextColor(...TASIS_NAVY);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Document:', margin, y);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(...BLACK);
    doc.text(file?.name || 'Unknown', margin + 30, y);
    y += 7;
    doc.setTextColor(...TASIS_NAVY);
    doc.setFont('helvetica', 'bold');
    doc.text('Policy Type:', margin, y);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(...BLACK);
    doc.text(POLICY_PRESETS[policyType]?.name || policyType, margin + 30, y);
    y += 7;
    doc.setTextColor(...TASIS_NAVY);
    doc.setFont('helvetica', 'bold');
    doc.text('Score:', margin, y);
    doc.setFont('helvetica', 'normal');
    const score = results?.overallScore || 0;
    const scoreColor = score >= 80 ? [5, 150, 105] : score >= 60 ? [217, 119, 6] : [...TASIS_RED];
    doc.setTextColor(...scoreColor);
    doc.text(`${score}%`, margin + 30, y);
    doc.setTextColor(...BLACK);

    y += 12;

    // Summary
    doc.setFillColor(...TASIS_LIGHT);
    doc.roundedRect(margin, y, contentWidth, 25, 2, 2, 'F');
    doc.setDrawColor(...TASIS_NAVY);
    doc.setLineWidth(0.3);
    doc.roundedRect(margin, y, contentWidth, 25, 2, 2, 'S');
    doc.setFontSize(10);
    doc.setTextColor(...TASIS_GREY);
    const summaryLines = doc.splitTextToSize(results?.summary || 'No summary available', contentWidth - 10);
    doc.text(summaryLines, margin + 5, y + 8);
    y += 30;

    // Template Checks
    doc.setTextColor(...TASIS_NAVY);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Template Compliance', margin, y);
    doc.setDrawColor(...TASIS_RED);
    doc.setLineWidth(0.8);
    doc.line(margin, y + 2, margin + 45, y + 2);
    y += 10;

    const templateChecks = results?.templateChecks || [];
    templateChecks.forEach(check => {
      if (y > pageHeight - 30) {
        doc.addPage();
        y = margin;
      }
      doc.setFontSize(10);
      const checkColor = check.pass ? [5, 150, 105] : [...TASIS_RED];
      doc.setTextColor(...checkColor);
      doc.text(check.pass ? 'âœ“' : 'âœ—', margin, y);
      doc.setTextColor(...BLACK);
      doc.setFont('helvetica', 'normal');
      const label = TASIS_TEMPLATE_CHECKS.find(t => t.id === check.id)?.label || check.id;
      doc.text(label, margin + 8, y);
      if (check.note) {
        doc.setTextColor(...TASIS_GREY);
        doc.setFontSize(9);
        doc.text(`(${check.note})`, margin + 8, y + 4);
        y += 4;
      }
      y += 6;
    });

    y += 10;

    // Content Issues
    if (results?.contentIssues?.length > 0) {
      if (y > pageHeight - 50) {
        doc.addPage();
        y = margin;
      }
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('Issues Found', margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 2, margin + 30, y + 2);
      y += 10;

      results.contentIssues.forEach(issue => {
        if (y > pageHeight - 30) {
          doc.addPage();
          y = margin;
        }
        const color = issue.type === 'error' ? [...TASIS_RED] : issue.type === 'warning' ? [217, 119, 6] : [...TASIS_NAVY];
        doc.setFillColor(...color);
        doc.circle(margin + 2, y - 1, 1.5, 'F');
        doc.setTextColor(...BLACK);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const issueLines = doc.splitTextToSize(issue.issue, contentWidth - 10);
        doc.text(issueLines, margin + 8, y);
        y += issueLines.length * 4 + 2;
        if (issue.suggestion) {
          doc.setFont('helvetica', 'italic');
          doc.setTextColor(...TASIS_GREY);
          doc.setFontSize(9);
          const suggestionLines = doc.splitTextToSize('â†’ ' + issue.suggestion, contentWidth - 12);
          doc.text(suggestionLines, margin + 10, y);
          y += suggestionLines.length * 4;
        }
        y += 4;
      });
    }

    y += 10;

    // Priority Actions
    if (results?.priorityActions?.length > 0) {
      if (y > pageHeight - 50) {
        doc.addPage();
        y = margin;
      }
      doc.setTextColor(...TASIS_NAVY);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('Priority Actions', margin, y);
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 2, margin + 38, y + 2);
      y += 10;

      results.priorityActions.forEach((action, i) => {
        if (y > pageHeight - 20) {
          doc.addPage();
          y = margin;
        }
        doc.setFillColor(...TASIS_NAVY);
        doc.circle(margin + 2, y - 1, 3, 'F');
        doc.setTextColor(...WHITE);
        doc.setFontSize(8);
        doc.text(String(i + 1), margin + 0.8, y + 0.5);
        doc.setTextColor(...BLACK);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        const actionLines = doc.splitTextToSize(action, contentWidth - 12);
        doc.text(actionLines, margin + 10, y);
        y += actionLines.length * 5 + 3;
      });
    }

    // Footer on each page
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      
      // Footer line
      doc.setDrawColor(...TASIS_NAVY);
      doc.setLineWidth(0.3);
      doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
      
      // Red accent
      doc.setDrawColor(...TASIS_RED);
      doc.setLineWidth(0.8);
      doc.line(margin, pageHeight - 14.5, margin + 25, pageHeight - 14.5);
      
      doc.setFontSize(8);
      doc.setTextColor(...TASIS_GREY);
      doc.text('TASIS England Policy Review Tool', margin, pageHeight - 10);
      doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }

    doc.save(`Policy_Review_${file?.name?.replace(/\.[^/.]+$/, '') || 'Report'}_${new Date().toISOString().split('T')[0]}.pdf`);
  };

  // Count results
  const passCount = results?.templateChecks?.filter(c => c.pass).length || 0;
  const failCount = results?.templateChecks?.filter(c => !c.pass).length || 0;
  const issueCount = results?.contentIssues?.length || 0;

  return React.createElement('div', { className: 'container' },
    // Header
    React.createElement('div', { style: { position: 'relative' } },
      React.createElement('div', { className: 'header' },
        React.createElement('a', { href: 'https://www.tasisengland.org', target: '_blank' },
          React.createElement('img', { src: 'https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png', alt: 'TASIS England' })
        ),
        React.createElement('div', null,
          React.createElement('h1', null, 'Policy Review Tool'),
          React.createElement('p', null, 'Upload â€¢ Analyse â€¢ Export')
        )
      ),
      React.createElement('button', { className: 'settings-toggle', onClick: () => setShowSettings(!showSettings), title: 'Settings' }, 'âš™ï¸')
    ),

    React.createElement('div', { className: 'card' },
      // Settings panel
      showSettings && React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, React.createElement('span', null, 'ðŸ”‘'), 'API Configuration'),
        React.createElement('div', { className: 'form-group' },
          React.createElement('label', null, 'Anthropic API Key'),
          React.createElement('input', {
            type: 'password',
            value: apiKey,
            onChange: e => setApiKey(e.target.value),
            placeholder: 'sk-ant-...'
          }),
          React.createElement('p', { className: 'hint' }, 'Get your key from console.anthropic.com. Stored in browser only.')
        ),
        React.createElement('button', { className: 'btn btn-primary', onClick: saveApiKey }, 'ðŸ’¾ Save & Close')
      ),

      // Upload section
      React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, React.createElement('span', null, 'ðŸ“„'), 'Upload Policy Document'),
        React.createElement('div', {
          className: `upload-zone ${file ? 'has-file' : ''}`,
          onClick: () => fileInputRef.current?.click(),
          onDrop: handleDrop,
          onDragOver: e => { e.preventDefault(); e.currentTarget.classList.add('dragover'); },
          onDragLeave: e => e.currentTarget.classList.remove('dragover')
        },
          React.createElement('input', {
            ref: fileInputRef,
            type: 'file',
            accept: '.pdf,.docx,.doc,.txt,.md',
            style: { display: 'none' },
            onChange: e => e.target.files[0] && handleFile(e.target.files[0])
          }),
          React.createElement('div', { className: 'upload-icon' }, file ? 'âœ…' : 'ðŸ“'),
          React.createElement('div', { className: 'upload-text' },
            file
              ? React.createElement('span', null, React.createElement('strong', null, file.name), React.createElement('br'), `${(file.size / 1024).toFixed(1)} KB â€¢ ${fileText.length.toLocaleString()} characters extracted`)
              : React.createElement('span', null, React.createElement('strong', null, 'Drop file here'), ' or click to browse', React.createElement('br'), 'Supports PDF, DOCX, TXT')
          )
        )
      ),

      // Requirements section
      React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, React.createElement('span', null, 'ðŸ“‹'), 'Requirements'),
        React.createElement('div', { className: 'form-row' },
          React.createElement('div', null,
            React.createElement('label', null, 'Policy Type'),
            React.createElement('select', { value: policyType, onChange: e => setPolicyType(e.target.value) },
              Object.entries(POLICY_PRESETS).map(([key, preset]) =>
                React.createElement('option', { key, value: key }, preset.name)
              )
            )
          )
        ),
        policyType !== 'custom' && POLICY_PRESETS[policyType]?.requirements && React.createElement('div', { className: 'preset-requirements' },
          React.createElement('strong', null, 'âœ“ Preset requirements for ', POLICY_PRESETS[policyType].name, ':'),
          POLICY_PRESETS[policyType].requirements.split('\n').slice(0, 6).join('\n'),
          '...'
        ),
        React.createElement('div', { className: 'form-group' },
          React.createElement('label', null, 'Additional Requirements (optional)'),
          React.createElement('textarea', {
            value: customRequirements,
            onChange: e => setCustomRequirements(e.target.value),
            placeholder: 'Add any specific requirements for this policy review...\n\nExamples:\n- Must include specific procedures for X\n- Must reference internal policy Y\n- Check that Z is up to date'
          })
        ),
        React.createElement('button', {
          className: 'btn btn-primary',
          onClick: analysePolicy,
          disabled: !file || !apiKey || loading
        }, loading ? 'â³ Analysing...' : 'ðŸ” Analyse Policy')
      ),

      // Loading
      loading && React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'loading' },
          React.createElement('div', { className: 'spinner' }),
          'Analysing policy against requirements...'
        )
      ),

      // Results section
      results && React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, React.createElement('span', null, 'ðŸ“Š'), 'Analysis Results'),
        
        // Summary stats
        React.createElement('div', { className: 'summary-bar' },
          React.createElement('div', { className: 'summary-stat', style: { background: results.overallScore >= 80 ? '#D1FAE5' : results.overallScore >= 60 ? '#FEF3C7' : '#FEE2E2', color: results.overallScore >= 80 ? '#065F46' : results.overallScore >= 60 ? '#92400E' : '#991B1B' } },
            React.createElement('div', { className: 'summary-num' }, results.overallScore, '%'),
            React.createElement('div', { className: 'summary-label' }, 'Score')
          ),
          React.createElement('div', { className: 'summary-stat pass' },
            React.createElement('div', { className: 'summary-num' }, passCount),
            React.createElement('div', { className: 'summary-label' }, 'Passed')
          ),
          React.createElement('div', { className: 'summary-stat fail' },
            React.createElement('div', { className: 'summary-num' }, failCount),
            React.createElement('div', { className: 'summary-label' }, 'Failed')
          ),
          React.createElement('div', { className: 'summary-stat warn' },
            React.createElement('div', { className: 'summary-num' }, issueCount),
            React.createElement('div', { className: 'summary-label' }, 'Issues')
          )
        ),

        // Summary text
        React.createElement('div', { style: { background: '#F8FAFC', padding: '12px 16px', borderRadius: '8px', marginBottom: '16px', fontSize: '14px', lineHeight: 1.6 } }, results.summary),

        // Template checks
        React.createElement('h4', { style: { fontSize: '13px', fontWeight: 600, color: '#1B3A5C', marginBottom: '10px' } }, 'Template Compliance'),
        React.createElement('div', { className: 'results' },
          results.templateChecks?.map((check, i) =>
            React.createElement('div', { key: i, className: 'result-item' },
              React.createElement('span', { className: `result-icon ${check.pass ? 'result-pass' : 'result-fail'}` }, check.pass ? 'âœ“' : 'âœ—'),
              React.createElement('div', null,
                React.createElement('strong', null, TASIS_TEMPLATE_CHECKS.find(t => t.id === check.id)?.label || check.id),
                check.note && React.createElement('span', { style: { color: '#64748B', marginLeft: '8px' } }, 'â€” ', check.note)
              )
            )
          )
        ),

        // Content issues
        results.contentIssues?.length > 0 && React.createElement('div', { style: { marginTop: '20px' } },
          React.createElement('h4', { style: { fontSize: '13px', fontWeight: 600, color: '#1B3A5C', marginBottom: '10px' } }, 'Issues Found'),
          React.createElement('div', { className: 'results' },
            results.contentIssues.map((issue, i) =>
              React.createElement('div', { key: i, className: 'result-item' },
                React.createElement('span', { className: `result-icon ${issue.type === 'error' ? 'result-fail' : issue.type === 'warning' ? 'result-warn' : 'result-info'}` },
                  issue.type === 'error' ? 'âœ—' : issue.type === 'warning' ? 'âš ' : 'â„¹'
                ),
                React.createElement('div', null,
                  React.createElement('strong', null, issue.issue),
                  issue.location && React.createElement('span', { style: { color: '#64748B', fontSize: '12px', marginLeft: '8px' } }, '(', issue.location, ')'),
                  issue.suggestion && React.createElement('div', { style: { color: '#059669', fontSize: '12px', marginTop: '4px' } }, 'â†’ ', issue.suggestion)
                )
              )
            )
          )
        ),

        // Priority actions
        results.priorityActions?.length > 0 && React.createElement('div', { style: { marginTop: '20px' } },
          React.createElement('h4', { style: { fontSize: '13px', fontWeight: 600, color: '#1B3A5C', marginBottom: '10px' } }, 'Priority Actions'),
          React.createElement('ol', { style: { paddingLeft: '20px', fontSize: '13px', lineHeight: 1.8 } },
            results.priorityActions.map((action, i) =>
              React.createElement('li', { key: i, style: { marginBottom: '6px' } }, action)
            )
          )
        ),

        // Export buttons
        React.createElement('div', { className: 'btn-group', style: { marginTop: '20px' } },
          React.createElement('button', { className: 'btn btn-outline', onClick: generatePDF }, 'ðŸ“‹ Download Review Report'),
          React.createElement('button', { 
            className: 'btn btn-primary', 
            onClick: restructurePolicy,
            disabled: restructuring
          }, restructuring ? 'â³ Formatting...' : 'ðŸ“„ Format into TASIS Template')
        )
      ),

      // Restructuring in progress
      restructuring && React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'loading' },
          React.createElement('div', { className: 'spinner' }),
          'Formatting policy into TASIS template...'
        )
      ),

      // Restructured output
      restructured && React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, React.createElement('span', null, 'ðŸ“„'), 'Formatted Policy'),
        
        // Preview
        React.createElement('div', { style: { background: '#F8FAFC', borderRadius: '8px', padding: '16px', marginBottom: '16px' } },
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' } },
            React.createElement('div', null,
              React.createElement('h3', { style: { margin: 0, fontSize: '16px', color: '#1B3A5C' } }, restructured.policyTitle),
              React.createElement('p', { style: { margin: '4px 0 0', fontSize: '12px', color: '#64748B' } }, 
                `Version ${restructured.version || '1.0'} â€¢ ${restructured.responsibleArea || 'Not specified'} â€¢ Review: ${restructured.reviewDate || 'Not set'}`
              )
            ),
            React.createElement('span', { style: { 
              background: '#D1FAE5', color: '#065F46', padding: '4px 10px', borderRadius: '4px', fontSize: '11px', fontWeight: 600 
            }}, 'âœ“ TASIS Template')
          ),
          
          // Metadata preview
          React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '8px', marginBottom: '12px' } },
            React.createElement('div', { style: { background: '#FFF', padding: '8px', borderRadius: '4px', fontSize: '11px' } },
              React.createElement('div', { style: { color: '#94A3B8', marginBottom: '2px' } }, 'Document Ref'),
              React.createElement('div', { style: { fontWeight: 600 } }, `TASIS_${restructured.shortCode || 'POL'}_v${restructured.version || '1.0'}`)
            ),
            React.createElement('div', { style: { background: '#FFF', padding: '8px', borderRadius: '4px', fontSize: '11px' } },
              React.createElement('div', { style: { color: '#94A3B8', marginBottom: '2px' } }, 'Sections'),
              React.createElement('div', { style: { fontWeight: 600 } }, restructured.sections?.length || 0)
            ),
            React.createElement('div', { style: { background: '#FFF', padding: '8px', borderRadius: '4px', fontSize: '11px' } },
              React.createElement('div', { style: { color: '#94A3B8', marginBottom: '2px' } }, 'Legislation Refs'),
              React.createElement('div', { style: { fontWeight: 600 } }, restructured.legislationReferenced?.length || 0)
            )
          ),
          
          // Sections list
          React.createElement('div', { style: { fontSize: '12px' } },
            React.createElement('div', { style: { fontWeight: 600, color: '#475569', marginBottom: '6px' } }, 'Contents:'),
            React.createElement('ol', { style: { margin: 0, paddingLeft: '20px', color: '#64748B' } },
              (restructured.sections || []).slice(0, 8).map((s, i) => 
                React.createElement('li', { key: i, style: { marginBottom: '2px' } }, s.title)
              ),
              (restructured.sections || []).length > 8 && React.createElement('li', { style: { fontStyle: 'italic' } }, `...and ${restructured.sections.length - 8} more sections`)
            )
          )
        ),
        
        // Download button
        React.createElement('div', { className: 'btn-group' },
          React.createElement('button', { className: 'btn btn-success', onClick: generateRestructuredPDF }, 
            'ðŸ“¥ Download Formatted Policy (PDF)'
          )
        ),
        
        React.createElement('p', { style: { fontSize: '11px', color: '#94A3B8', marginTop: '12px' } },
          'The PDF includes: cover page, metadata table, signatory block, numbered sections, legislation references, and RESPOND framework box (if applicable).'
        )
      )
    ),

    // Footer
    React.createElement('div', { style: { textAlign: 'center', padding: '20px', fontSize: '11px', color: '#94A3B8' } },
      'Â© 2026 TASIS England â€¢ Policy Review Tool â€¢ RESPOND Safeguarding'
    )
  );
}

// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(PolicyReviewTool));
  </script>
</body>
</html>
