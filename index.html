<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TASIS Policy Tools</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F1F5F9; min-height: 100vh; }
    .container { max-width: 950px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header { background: linear-gradient(135deg, #0F1E33 0%, #1B3A5C 60%, #2C5AA0 100%); padding: 16px 24px; color: #FFF; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 14px; }
    .header img { height: 45px; }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header p { font-size: 11px; opacity: 0.7; margin-top: 2px; }
    
    /* Tabs */
    .tabs { display: flex; background: #1B3A5C; }
    .tab { flex: 1; padding: 14px 20px; text-align: center; cursor: pointer; color: rgba(255,255,255,0.6); font-weight: 600; font-size: 13px; border-bottom: 3px solid transparent; transition: all 0.2s; }
    .tab:hover { color: rgba(255,255,255,0.9); background: rgba(255,255,255,0.05); }
    .tab.active { color: #FFF; border-bottom-color: #C8102E; background: rgba(255,255,255,0.1); }
    .tab-icon { font-size: 18px; margin-right: 8px; }
    
    /* Card */
    .card { background: #FFF; border-radius: 0 0 12px 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .section { padding: 24px; border-bottom: 1px solid #E2E8F0; }
    .section:last-child { border-bottom: none; }
    .section-title { font-size: 12px; font-weight: 700; color: #1B3A5C; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    
    /* Upload */
    .upload-zone { border: 2px dashed #CBD5E1; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover, .upload-zone.dragover { border-color: #1B3A5C; background: #F8FAFC; }
    .upload-zone.has-file { border-color: #10B981; background: #ECFDF5; }
    .upload-icon { font-size: 36px; margin-bottom: 10px; }
    .upload-text { color: #64748B; font-size: 13px; }
    .upload-text strong { color: #1B3A5C; }
    
    /* File info table */
    .file-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    .file-table th { text-align: left; padding: 8px 12px; background: #F8FAFC; color: #1B3A5C; font-weight: 600; border-bottom: 2px solid #E2E8F0; }
    .file-table td { padding: 8px 12px; border-bottom: 1px solid #E2E8F0; color: #374151; }
    .file-table tr:last-child td { border-bottom: none; }
    
    /* Buttons */
    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 13px; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: linear-gradient(135deg, #1B3A5C, #2C5AA0); color: #FFF; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(27,58,92,0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-success { background: linear-gradient(135deg, #059669, #10B981); color: #FFF; }
    .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(5,150,105,0.3); }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    
    /* Select */
    select { width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 13px; background: #FFF; cursor: pointer; }
    select:focus { outline: none; border-color: #1B3A5C; }
    
    /* Results */
    .results-box { background: #F8FAFC; border-radius: 10px; padding: 20px; margin-top: 20px; }
    .score { font-size: 42px; font-weight: 800; color: #1B3A5C; }
    .score-label { font-size: 12px; color: #64748B; text-transform: uppercase; }
    .summary { background: #FFF; border-left: 4px solid #1B3A5C; padding: 15px; margin: 15px 0; font-size: 13px; line-height: 1.6; color: #374151; }
    
    /* Checks */
    .check-item { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #F1F5F9; }
    .check-item:last-child { border-bottom: none; }
    .check-icon { font-size: 18px; }
    .check-pass { color: #10B981; }
    .check-fail { color: #EF4444; }
    .check-label { font-weight: 600; color: #1B3A5C; font-size: 13px; }
    .check-note { font-size: 12px; color: #64748B; margin-top: 2px; }
    
    /* Issues */
    .issue { padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
    .issue-error { background: #FEF2F2; border-left: 4px solid #EF4444; }
    .issue-warning { background: #FFFBEB; border-left: 4px solid #F59E0B; }
    .issue-info { background: #EFF6FF; border-left: 4px solid #3B82F6; }
    .issue-title { font-weight: 600; color: #1E293B; margin-bottom: 4px; }
    .issue-suggestion { color: #64748B; font-style: italic; }
    
    /* Priority list */
    .priority-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #F1F5F9; }
    .priority-num { width: 28px; height: 28px; background: #C8102E; color: #FFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; }
    .priority-text { font-size: 13px; color: #374151; }
    
    /* Settings */
    .settings-toggle { font-size: 12px; color: #64748B; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .settings-toggle:hover { color: #1B3A5C; }
    .settings-panel { background: #F8FAFC; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .settings-panel input { width: 100%; padding: 10px; border: 1px solid #E2E8F0; border-radius: 6px; font-family: monospace; font-size: 12px; }
    
    /* Formatted output preview */
    .preview-section { background: #F8FAFC; border-radius: 8px; padding: 15px; margin-top: 15px; }
    .preview-title { font-weight: 600; color: #1B3A5C; margin-bottom: 10px; font-size: 14px; }
    .preview-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; }
    .preview-meta dt { color: #64748B; }
    .preview-meta dd { color: #1E293B; font-weight: 500; }
    .preview-sections { margin-top: 15px; max-height: 300px; overflow-y: auto; }
    .preview-section-item { padding: 8px 12px; background: #FFF; border-radius: 6px; margin-bottom: 6px; font-size: 12px; }
    .preview-section-num { color: #C8102E; font-weight: 600; }
    .preview-section-title { color: #1B3A5C; font-weight: 500; }
    .preview-section-chars { color: #94A3B8; font-size: 11px; }
    
    /* Loading */
    .loading { display: flex; align-items: center; gap: 10px; color: #64748B; font-size: 13px; }
    .spinner { width: 20px; height: 20px; border: 2px solid #E2E8F0; border-top-color: #1B3A5C; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Footer */
    .footer { text-align: center; padding: 20px; font-size: 11px; color: #94A3B8; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
const { useState, useEffect } = React;

// Policy type presets for review
const POLICY_PRESETS = {
  "safeguarding": {
    name: "Safeguarding & Child Protection",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference KCSIE 2025 (not older versions)
- Must reference Working Together 2023 (NOT 2025 - there is no 2025 version)
- Must include DSL contact details (Jason Tait)
- Must define types of abuse (physical, emotional, sexual, neglect)
- Must include procedures for reporting concerns
- Must reference local safeguarding partnership (Surrey)
- Must address child-on-child abuse
- Must include online safety provisions
- Must include staff training requirements
- Must have clear escalation procedures
- Must address children with SEND
- Must include information sharing protocols`
  },
  "boarding": {
    name: "Boarding",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference National Minimum Standards for Boarding 2022
- Must include welfare provisions
- Must address supervision ratios
- Must include contact arrangements with parents
- Must address health and medical needs
- Must include safeguarding procedures specific to boarding
- Must reference KCSIE 2025
- Must address overnight supervision
- Must include fire safety procedures
- Must address missing boarder procedures`
  },
  "behaviour": {
    name: "Behaviour & Discipline",
    requirements: `MANDATORY REQUIREMENTS:
- Must be consistent with Equality Act 2010
- Must include rewards and sanctions
- Must address bullying (including cyber-bullying)
- Must reference exclusion procedures
- Must address reasonable force/restraint
- Must include searching and confiscation
- Must address SEND considerations
- Must include pastoral support
- Must reference anti-bullying policy`
  },
  "health_safety": {
    name: "Health & Safety",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference Health and Safety at Work Act 1974
- Must include risk assessment procedures
- Must address fire safety
- Must include first aid provisions
- Must address educational visits
- Must include accident reporting
- Must address contractor management`
  },
  "recruitment": {
    name: "Safer Recruitment",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference KCSIE 2025 Part 3
- Must include DBS check requirements
- Must address single central record
- Must include interview procedures
- Must address references and verification
- Must include prohibition checks
- Must address overseas checks for international staff`
  },
  "complaints": {
    name: "Complaints",
    requirements: `MANDATORY REQUIREMENTS:
- Must have clear staged process
- Must include timescales
- Must address informal and formal stages
- Must include panel hearing procedures
- Must reference record keeping
- Must include appeals process`
  },
  "equality": {
    name: "Equality & Diversity",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference Equality Act 2010
- Must address protected characteristics
- Must include accessibility provisions
- Must address discrimination and harassment
- Must include monitoring and reporting
- Must reference Public Sector Equality Duty`
  },
  "rshe": {
    name: "RSHE (Relationships, Sex & Health Education)",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference statutory RSHE guidance
- Must include parent consultation
- Must address right to withdraw
- Must include age-appropriate content
- Must address SEND considerations
- Must reference Relationships Education statutory guidance`
  },
  "admissions": {
    name: "Admissions",
    requirements: `MANDATORY REQUIREMENTS:
- Must include entry requirements
- Must address SEND admissions
- Must include assessment procedures
- Must address international students
- Must include waiting list procedures
- Must include appeals process`
  },
  "data_protection": {
    name: "Data Protection & Privacy",
    requirements: `MANDATORY REQUIREMENTS:
- Must reference UK GDPR and Data Protection Act 2018
- Must include lawful bases for processing
- Must address data subject rights
- Must include retention schedules
- Must address data breaches
- Must include privacy notices`
  },
  "other": {
    name: "Other Policy",
    requirements: `GENERAL REQUIREMENTS:
- Clear purpose and scope
- Defined roles and responsibilities
- Review date specified
- Compliant with relevant legislation`
  }
};

// TASIS template checks
const TASIS_TEMPLATE_CHECKS = [
  { id: "safeguarding_stmt", label: "Safeguarding commitment statement", required: true },
  { id: "scope_stmt", label: "Whole-school scope statement (including Boarding/EYFS)", required: true },
  { id: "version_stmt", label: "Current version statement", required: true },
  { id: "metadata", label: "Metadata table (7 fields)", required: true },
  { id: "signatory", label: "Signatory block (Head of School, Chair)", required: true },
  { id: "numbered_sections", label: "Numbered sections", required: true },
  { id: "review_date", label: "Review/update date specified", required: true },
  { id: "responsible", label: "Responsible area/person identified", required: true },
  { id: "legislation_refs", label: "Legislation references current", required: false },
];

function PolicyTools() {
  // State
  const [activeTab, setActiveTab] = useState('review'); // 'review' or 'format'
  const [apiKey, setApiKey] = useState(localStorage.getItem('tasis_api_key') || '');
  const [showSettings, setShowSettings] = useState(false);
  const [file, setFile] = useState(null);
  const [fileText, setFileText] = useState('');
  const [fileHtml, setFileHtml] = useState(null); // HTML from mammoth for docx
  const [policyType, setPolicyType] = useState('safeguarding');
  const [loading, setLoading] = useState(false);
  
  // Review state
  const [reviewResults, setReviewResults] = useState(null);
  
  // Format state
  const [formatResults, setFormatResults] = useState(null);

  // Save API key
  useEffect(() => {
    if (apiKey) localStorage.setItem('tasis_api_key', apiKey);
  }, [apiKey]);

  // File reading - use mammoth HTML for docx to preserve structure
  const readFile = async (f) => {
    setFile(f);
    setReviewResults(null);
    setFormatResults(null);
    
    const ext = f.name.split('.').pop().toLowerCase();
    
    try {
      if (ext === 'txt') {
        setFileText(await f.text());
        setFileHtml(null);
      } else if (ext === 'docx') {
        const arrayBuffer = await f.arrayBuffer();
        // Get both raw text (for AI review) and HTML (for formatting)
        const textResult = await mammoth.extractRawText({ arrayBuffer });
        const htmlResult = await mammoth.convertToHtml({ arrayBuffer });
        
        // Post-process HTML to detect headings from patterns
        let processedHtml = detectHeadings(htmlResult.value);
        
        setFileText(textResult.value);
        setFileHtml(processedHtml);
        
      } else if (ext === 'pdf') {
        const arrayBuffer = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let allText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          
          const items = content.items.filter(item => item.str.trim());
          items.sort((a, b) => {
            const yDiff = b.transform[5] - a.transform[5];
            if (Math.abs(yDiff) > 5) return yDiff;
            return a.transform[4] - b.transform[4];
          });
          
          let lastY = null;
          let lineText = '';
          
          for (const item of items) {
            const y = Math.round(item.transform[5]);
            if (lastY !== null && Math.abs(y - lastY) > 5) {
              allText += lineText.trim() + '\n';
              lineText = '';
              if (Math.abs(y - lastY) > 15) allText += '\n';
            }
            lineText += item.str + ' ';
            lastY = y;
          }
          if (lineText.trim()) allText += lineText.trim() + '\n';
          allText += '\n';
        }
        
        setFileText(allText.trim());
        setFileHtml(null); // No HTML for PDFs
      } else {
        alert('Please upload a .txt, .docx, or .pdf file');
        setFile(null);
      }
    } catch (e) {
      alert('Error reading file: ' + e.message);
      setFile(null);
    }
  };

  // Smart heading and list detection - uses regex for browser compatibility
  const detectHeadings = (html) => {
    let result = html;
    
    // === STEP 1: DETECT AND CONVERT HEADINGS ===
    
    // Pattern 1: Numbered main sections "1. Introduction" wrapped in <p>
    result = result.replace(/<p>(\d+\.?\s+[A-Z][^<]{5,70})<\/p>/g, (match, content) => {
      if (content.includes(',') || content.includes(';')) return match;
      return `<h2>${content}</h2>`;
    });
    
    // Pattern 2: Numbered subsections "1.1 Policy Aims" or "1.1. Policy"
    result = result.replace(/<p>(\d+\.\d+\.?\s+[A-Z][^<]{3,70})<\/p>/g, '<h3>$1</h3>');
    
    // Pattern 3: Bold paragraphs that are short (likely headings)
    result = result.replace(/<p><strong>([^<]{3,60})<\/strong><\/p>/g, (match, content) => {
      // Skip if it looks like a sentence (has period in middle, or commas)
      if (/[,;]/.test(content) || /\.\s/.test(content)) return match;
      // Skip if all lowercase
      if (content === content.toLowerCase()) return match;
      return `<h3>${content}</h3>`;
    });
    
    // Pattern 4: Bold text ending with colon (subheading)
    result = result.replace(/<p><strong>([^<]{3,50}:)<\/strong><\/p>/g, '<h4>$1</h4>');
    result = result.replace(/<p><strong>([^<]{3,50}):<\/strong><\/p>/g, '<h4>$1:</h4>');
    
    // Pattern 5: Common section names as standalone paragraphs
    const sectionNames = [
      'Introduction', 'Definitions', 'Policy Aims', 'Equalities Statement',
      'Supporting Children', 'Professional Expectations', 'Safeguarding Statement',
      'Key Personnel', 'Contents', 'Additional Resources', 'Whistleblowing',
      'Physical Intervention', 'Attendance', 'Behaviour', 'Online Safety',
      'Mental Health', 'Prevent', 'Reporting', 'References', 'Glossary',
      'Version Control', 'Document Control', 'Scope', 'Purpose', 'Responsibilities',
      'Training', 'Monitoring', 'Complaints', 'Appeals', 'Contact', 'Emergency',
      'Procedures', 'Guidelines', 'Standards', 'Requirements', 'Compliance',
      'Legislation', 'Statutory', 'Governance', 'Leadership', 'Management',
      'Assessment', 'Evaluation', 'Support', 'Intervention', 'Safeguarding',
      'Protection', 'Welfare', 'Safety', 'Health', 'Wellbeing', 'Equality',
      'Diversity', 'Inclusion', 'Communication', 'Information', 'Data',
      'Records', 'Confidentiality', 'Disclosure', 'Referral', 'Escalation',
      'Investigation', 'Outcome', 'Review', 'Audit', 'Quality', 'Appendix'
    ];
    
    const sectionPattern = new RegExp(
      `<p>(${sectionNames.join('|')}[^<]{0,30})</p>`,
      'gi'
    );
    result = result.replace(sectionPattern, '<h2>$1</h2>');
    
    // === STEP 2: DETECT AND CONVERT BULLET LISTS ===
    
    // Convert bullet-prefixed paragraphs to list items
    // First, wrap consecutive bullet paragraphs in <ul>
    result = result.replace(
      /(<p>[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´‚Äì‚Äî]\s*[^<]+<\/p>\s*)+/g,
      (match) => {
        const items = match.match(/<p>[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´‚Äì‚Äî]\s*([^<]+)<\/p>/g);
        if (items && items.length >= 2) {
          const lis = items.map(item => {
            const content = item.replace(/<p>[‚Ä¢‚óè‚óã‚ó¶‚ñ™‚ñ´‚Äì‚Äî]\s*/, '').replace(/<\/p>/, '');
            return `<li>${content}</li>`;
          }).join('\n');
          return `<ul>\n${lis}\n</ul>`;
        }
        return match;
      }
    );
    
    // === STEP 3: DETECT AND CONVERT NUMBERED LISTS ===
    
    // Convert numbered paragraphs (1. 2. 3. or 1) 2) 3)) to ordered list
    result = result.replace(
      /(<p>\d+[.)]\s*[^<]+<\/p>\s*)+/g,
      (match) => {
        const items = match.match(/<p>\d+[.)]\s*([^<]+)<\/p>/g);
        if (items && items.length >= 2) {
          const lis = items.map(item => {
            const content = item.replace(/<p>\d+[.)]\s*/, '').replace(/<\/p>/, '');
            return `<li>${content}</li>`;
          }).join('\n');
          return `<ol>\n${lis}\n</ol>`;
        }
        return match;
      }
    );
    
    // === STEP 4: DETECT LETTER LISTS (a. b. c. or a) b) c)) ===
    result = result.replace(
      /(<p>[a-z][.)]\s*[^<]+<\/p>\s*)+/gi,
      (match) => {
        const items = match.match(/<p>[a-z][.)]\s*([^<]+)<\/p>/gi);
        if (items && items.length >= 2) {
          const lis = items.map(item => {
            const content = item.replace(/<p>[a-z][.)]\s*/i, '').replace(/<\/p>/, '');
            return `<li>${content}</li>`;
          }).join('\n');
          return `<ol style="list-style-type: lower-alpha;">\n${lis}\n</ol>`;
        }
        return match;
      }
    );
    
    // === STEP 5: CLEAN UP EMPTY PARAGRAPHS ===
    result = result.replace(/<p>\s*<\/p>/g, '');
    result = result.replace(/<p>&nbsp;<\/p>/g, '');
    result = result.replace(/<p> <\/p>/g, '');
    
    return result;
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TAB 1: POLICY REVIEW (AI-powered compliance check)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const runReview = async () => {
    if (!fileText || !apiKey) return;
    
    setLoading(true);
    setReviewResults(null);
    
    const preset = POLICY_PRESETS[policyType];
    
    const systemPrompt = `You are a UK school policy compliance reviewer for TASIS The American School in England.

Your task is to review the uploaded policy document against:
1. The TASIS standard template requirements
2. The specific policy type requirements provided

TASIS TEMPLATE REQUIREMENTS:
- Safeguarding commitment statement at the top
- Scope statement: "This policy applies to the whole school including Boarding and the Early Years"
- Version statement about current version on website
- Metadata table with: Information Sharing Category, Document Reference, Version, Date Published, Date Ratified, Review Date, Responsible Area
- Signatory block with Head of School (Bryan Nixon) and Chair of Board (David King)
- Numbered sections throughout
- Review/update date clearly specified

CRITICAL LEGISLATION RULES:
- KCSIE: Must reference 2025 version (current)
- Working Together: Must reference 2023 version. THERE IS NO "WORKING TOGETHER 2025" - IT DOES NOT EXIST. 
  If the policy says "Working Together 2025", this is an ERROR - it should be "Working Together 2023".
  If the policy correctly says "Working Together 2023", this is CORRECT - do NOT suggest changing it.

Template check IDs to use: safeguarding_stmt, scope_stmt, version_stmt, metadata, signatory, numbered_sections, review_date, responsible, legislation_refs

Respond in JSON format:
{
  "summary": "Brief overall assessment (2-3 sentences)",
  "overallScore": 85,
  "templateChecks": [
    {"id": "safeguarding_stmt", "pass": true, "note": "Present on page 1"},
    {"id": "scope_stmt", "pass": false, "note": "Missing - needs to be added"}
  ],
  "contentIssues": [
    {"type": "error", "issue": "Description", "location": "Section X", "suggestion": "How to fix"}
  ],
  "missingElements": ["List of elements that should be added"],
  "outdatedReferences": ["Any legislation or guidance that needs updating - remember Working Together 2023 is CORRECT"],
  "strengthAreas": ["What the policy does well"],
  "priorityActions": ["Top 3-5 actions in order of importance"]
}`;

    const userPrompt = `POLICY TYPE: ${preset.name}

SPECIFIC REQUIREMENTS FOR THIS POLICY:
${preset.requirements}

POLICY DOCUMENT TO REVIEW:
${fileText.substring(0, 80000)}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 4000,
          messages: [{ role: 'user', content: userPrompt }],
          system: systemPrompt
        })
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);

      const data = await response.json();
      const text = data.content[0].text;
      
      // Parse JSON response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        const cleanJSON = (str) => {
          let inString = false, escaped = false, result = '';
          for (let i = 0; i < str.length; i++) {
            const char = str[i];
            if (escaped) { result += char; escaped = false; continue; }
            if (char === '\\') { escaped = true; result += char; continue; }
            if (char === '"') { inString = !inString; result += char; continue; }
            if (inString) {
              if (char === '\n') result += '\\n';
              else if (char === '\r') result += '';
              else if (char === '\t') result += '\\t';
              else if (char.charCodeAt(0) < 32) result += ' ';
              else result += char;
            } else result += char;
          }
          return result;
        };
        setReviewResults(JSON.parse(cleanJSON(jsonMatch[0])));
      } else {
        throw new Error('Could not parse response');
      }
    } catch (e) {
      alert('Error reviewing policy: ' + e.message);
    } finally {
      setLoading(false);
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TAB 2: POLICY FORMATTER (preserves original structure, adds TASIS wrapper)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  const runFormat = async () => {
    if (!fileText || !apiKey) return;
    
    setLoading(true);
    setFormatResults(null);
    
    try {
      // AI extracts ONLY metadata (small task - first 15k chars)
      const metadataPrompt = `Extract ONLY the document metadata from this policy. Return JSON:
{
  "policyTitle": "exact title",
  "shortCode": "e.g. SCP, BEH",
  "version": "e.g. 5.0",
  "datePublished": "date",
  "dateRatified": "date", 
  "reviewDate": "date",
  "responsibleArea": "owner/department",
  "infoSharingCategory": "PUBLIC or INTERNAL",
  "scope": "scope statement",
  "legislationReferenced": ["laws and guidance cited"],
  "signatories": [{"role": "role", "name": "name", "date": "date"}],
  "crossReferences": ["related policies mentioned"]
}

Document start:
${fileText.substring(0, 15000)}`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 2000,
          temperature: 0,
          messages: [{ role: 'user', content: metadataPrompt }]
        })
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);

      const data = await response.json();
      let responseText = data.content[0].text;
      
      // Parse JSON
      responseText = responseText.replace(/```json\s*/g, '').replace(/```\s*/g, '');
      const jsonStart = responseText.indexOf('{');
      const jsonEnd = responseText.lastIndexOf('}');
      
      let metadata = {};
      if (jsonStart !== -1 && jsonEnd !== -1) {
        try {
          metadata = JSON.parse(responseText.substring(jsonStart, jsonEnd + 1));
        } catch (e) {
          console.warn('Metadata parse warning:', e.message);
        }
      }
      
      // Use mammoth HTML if available, otherwise convert text to basic HTML
      let contentHtml = fileHtml;
      if (!contentHtml) {
        // Convert plain text to paragraphs
        contentHtml = fileText
          .split(/\n\n+/)
          .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
          .join('\n');
      }
      
      const result = {
        policyTitle: metadata.policyTitle || 'Policy Document',
        shortCode: metadata.shortCode || 'POL',
        version: metadata.version || '1.0',
        datePublished: metadata.datePublished || '',
        dateRatified: metadata.dateRatified || '',
        reviewDate: metadata.reviewDate || '',
        responsibleArea: metadata.responsibleArea || '',
        infoSharingCategory: metadata.infoSharingCategory || 'PUBLIC',
        scope: metadata.scope || 'the whole school including Boarding and the Early Years',
        legislationReferenced: metadata.legislationReferenced || [],
        signatories: metadata.signatories || [
          { role: 'Head of School', name: 'Bryan Nixon', date: '' },
          { role: 'Chair of Board', name: 'David King', date: '' }
        ],
        crossReferences: metadata.crossReferences || [],
        contentHtml: contentHtml, // Preserved HTML structure from document
        originalLength: fileText.length,
        hasStructure: !!fileHtml // True if we have mammoth HTML
      };
      
      setFormatResults(result);
      
    } catch (e) {
      console.error('Format error:', e);
      alert('Error formatting policy: ' + e.message);
    } finally {
      setLoading(false);
    }
  };

  // Quick format - no AI at all
  const quickFormat = () => {
    if (!fileText) return;
    
    const title = prompt('Policy title:', file?.name?.replace(/\.[^.]+$/, '').replace(/_/g, ' ') || 'Policy Document');
    if (!title) return;
    
    let contentHtml = fileHtml;
    if (!contentHtml) {
      contentHtml = fileText
        .split(/\n\n+/)
        .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
        .join('\n');
    }
    
    const result = {
      policyTitle: title,
      shortCode: 'POL',
      version: '1.0',
      datePublished: new Date().toLocaleDateString('en-GB'),
      dateRatified: '',
      reviewDate: '',
      responsibleArea: '',
      infoSharingCategory: 'PUBLIC',
      scope: 'the whole school including Boarding and the Early Years',
      legislationReferenced: [],
      signatories: [
        { role: 'Head of School', name: 'Bryan Nixon', date: '' },
        { role: 'Chair of Board', name: 'David King', date: '' }
      ],
      crossReferences: [],
      contentHtml: contentHtml,
      originalLength: fileText.length,
      hasStructure: !!fileHtml
    };
    
    setFormatResults(result);
  };

  // Generate HTML output
  const downloadHTML = () => {
    if (!formatResults) return;
    
    const r = formatResults;
    const escapeHtml = (s) => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${escapeHtml(r.policyTitle)}</title>
  <style>
    @page { size: A4; margin: 15mm 20mm; }
    @media print { 
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
      .no-print { display: none !important; } 
      .page { box-shadow: none !important; margin: 0 !important; max-width: none !important; }
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; font-size: 10.5pt; line-height: 1.6; color: #1a1a1a; background: #e5e7eb; }
    .page { background: white; max-width: 210mm; margin: 20px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .header { background: linear-gradient(135deg, #1E3A5F, #2a4a6f); color: white; padding: 18px 25px; display: flex; align-items: center; gap: 18px; border-bottom: 4px solid #C8102E; }
    .header img { height: 55px; }
    .header-text h1 { font-size: 15pt; font-weight: 600; margin-bottom: 3px; }
    .header-text p { font-size: 9pt; opacity: 0.85; }
    .content { padding: 25px 30px; }
    .safeguarding-box { background: linear-gradient(to right, #f0f9ff, #f8fafc); border-left: 4px solid #1E3A5F; padding: 14px 18px; margin-bottom: 22px; font-style: italic; color: #1E3A5F; font-size: 9.5pt; }
    .scope-text { color: #64748b; font-size: 9pt; margin-bottom: 22px; }
    .meta-title { color: #1E3A5F; font-size: 11pt; font-weight: 700; padding-bottom: 6px; margin-bottom: 12px; border-bottom: 2px solid #C8102E; display: inline-block; }
    .meta-section { margin-bottom: 22px; }
    .meta-table { width: 100%; border-collapse: collapse; font-size: 9.5pt; }
    .meta-table th { text-align: left; padding: 6px 10px; background: #f8fafc; color: #1E3A5F; font-weight: 600; border: 1px solid #e2e8f0; width: 140px; }
    .meta-table td { padding: 6px 10px; border: 1px solid #e2e8f0; color: #374151; }
    
    /* Policy content styling - applies to mammoth HTML output */
    .policy-body { font-size: 10pt; line-height: 1.7; color: #1f2937; }
    .policy-body h1 { color: #1E3A5F; font-size: 14pt; font-weight: 700; margin: 25px 0 12px 0; padding-bottom: 6px; border-bottom: 2px solid #C8102E; }
    .policy-body h2 { color: #1E3A5F; font-size: 12pt; font-weight: 700; margin: 20px 0 10px 0; padding-bottom: 4px; border-bottom: 1px solid #C8102E; }
    .policy-body h3 { color: #1E3A5F; font-size: 11pt; font-weight: 600; margin: 16px 0 8px 0; }
    .policy-body h4 { color: #1E3A5F; font-size: 10.5pt; font-weight: 600; margin: 14px 0 6px 0; font-style: italic; }
    .policy-body h5, .policy-body h6 { color: #1E3A5F; font-size: 10pt; font-weight: 600; margin: 12px 0 5px 0; }
    .policy-body p { margin-bottom: 10px; }
    .policy-body ul, .policy-body ol { margin: 10px 0 15px 20px; padding-left: 10px; }
    .policy-body ul { list-style-type: disc; }
    .policy-body ol { list-style-type: decimal; }
    .policy-body li { margin-bottom: 6px; padding-left: 5px; }
    .policy-body ul ul, .policy-body ol ol, .policy-body ul ol, .policy-body ol ul { margin: 5px 0 5px 15px; }
    .policy-body table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 9.5pt; }
    .policy-body table th, .policy-body table td { padding: 8px 10px; border: 1px solid #e2e8f0; text-align: left; }
    .policy-body table th { background: #f8fafc; color: #1E3A5F; font-weight: 600; }
    .policy-body strong { color: #1E3A5F; }
    .policy-body a { color: #2563eb; text-decoration: underline; }
    .policy-body a:hover { color: #1d4ed8; }
    
    .footer { border-top: 1px solid #cbd5e1; margin-top: 30px; padding-top: 15px; display: flex; justify-content: space-between; font-size: 8pt; color: #64748b; }
    .footer-accent { width: 40px; height: 3px; background: #C8102E; margin-bottom: 6px; }
    .print-btn { position: fixed; top: 25px; right: 25px; background: linear-gradient(135deg, #1E3A5F, #2a4a6f); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 11pt; font-weight: 600; box-shadow: 0 4px 12px rgba(30,58,95,0.3); z-index: 1000; }
    .print-btn:hover { transform: translateY(-2px); }
  </style>
</head>
<body>
  <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
  
  <div class="page">
    <div class="header">
      <img src="https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png" alt="TASIS England">
      <div class="header-text">
        <h1>${escapeHtml(r.policyTitle)}</h1>
        <p>${escapeHtml(r.shortCode)} v${escapeHtml(r.version)} &nbsp;‚Ä¢&nbsp; ${escapeHtml(r.datePublished)}</p>
      </div>
    </div>
    
    <div class="content">
      <div class="safeguarding-box">
        TASIS England is committed to safeguarding and promoting the welfare of students and expects all faculty, staff and volunteers to share this commitment. It is our aim that all students fulfil their potential.
      </div>
      
      <p class="scope-text">This policy applies to the whole school including ${escapeHtml(r.scope)}. The current version of any policy is the version held on the TASIS England website.</p>
      
      <div class="meta-section">
        <div class="meta-title">Document Information</div>
        <table class="meta-table">
          <tr><th>Document Reference</th><td>TASIS_${escapeHtml(r.shortCode)}_v${escapeHtml(r.version)}</td></tr>
          <tr><th>Version</th><td>v${escapeHtml(r.version)}</td></tr>
          <tr><th>Published</th><td>${escapeHtml(r.datePublished) || '‚Äî'}</td></tr>
          <tr><th>Ratified</th><td>${escapeHtml(r.dateRatified) || '‚Äî'}</td></tr>
          <tr><th>Review Date</th><td>${escapeHtml(r.reviewDate) || '‚Äî'}</td></tr>
          <tr><th>Owner</th><td>${escapeHtml(r.responsibleArea) || '‚Äî'}</td></tr>
          <tr><th>Classification</th><td>${escapeHtml(r.infoSharingCategory)}</td></tr>
        </table>
      </div>
      
      <div class="meta-section">
        <div class="meta-title">Approved By</div>
        <table class="meta-table">
          ${r.signatories.map(s => `<tr><th>${escapeHtml(s.role)}</th><td>${escapeHtml(s.name)}${s.date ? ' (' + escapeHtml(s.date) + ')' : ''}</td></tr>`).join('')}
        </table>
      </div>
      
      ${r.legislationReferenced?.length ? `
      <div class="meta-section">
        <div class="meta-title">Statutory Compliance</div>
        <p style="font-size: 9.5pt; color: #374151;">${r.legislationReferenced.map(l => escapeHtml(l)).join('; ')}</p>
      </div>` : ''}
      
      <div class="policy-body">
        ${r.contentHtml || '<p>No content available</p>'}
      </div>
      
      ${r.crossReferences?.length ? `
      <div class="meta-section" style="margin-top: 25px;">
        <div class="meta-title">Related Policies</div>
        <p style="font-size: 9.5pt; color: #374151;">${r.crossReferences.map(x => escapeHtml(x)).join('; ')}</p>
      </div>` : ''}
      
      <div class="footer">
        <div><div class="footer-accent"></div>TASIS England is committed to safeguarding and promoting the welfare of students.</div>
        <div><strong>${escapeHtml(r.shortCode)}_v${escapeHtml(r.version)}</strong></div>
      </div>
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = (r.policyTitle || 'Policy').replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_') + '_TASIS.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // File info for table display
  const getFileInfo = () => {
    if (!file) return null;
    return {
      name: file.name,
      type: file.type || file.name.split('.').pop().toUpperCase(),
      size: (file.size / 1024).toFixed(1) + ' KB',
      chars: fileText.length.toLocaleString(),
      words: fileText.split(/\s+/).filter(w => w).length.toLocaleString()
    };
  };

  const fileInfo = getFileInfo();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  return React.createElement('div', { className: 'container' },
    // Header
    React.createElement('div', { className: 'header' },
      React.createElement('img', { src: 'https://raw.githubusercontent.com/Daddymac1969/Orah-passes/main/New%20TE%20Logo.png', alt: 'TASIS' }),
      React.createElement('div', null,
        React.createElement('h1', null, 'TASIS Policy Tools'),
        React.createElement('p', null, 'Review compliance ‚Ä¢ Format to template')
      )
    ),
    
    // Tabs
    React.createElement('div', { className: 'tabs' },
      React.createElement('div', { 
        className: `tab ${activeTab === 'review' ? 'active' : ''}`,
        onClick: () => setActiveTab('review')
      }, React.createElement('span', { className: 'tab-icon' }, 'üîç'), 'Policy Review'),
      React.createElement('div', { 
        className: `tab ${activeTab === 'format' ? 'active' : ''}`,
        onClick: () => setActiveTab('format')
      }, React.createElement('span', { className: 'tab-icon' }, 'üìÑ'), 'Policy Formatter')
    ),
    
    // Card
    React.createElement('div', { className: 'card' },
      
      // Settings
      React.createElement('div', { className: 'section' },
        React.createElement('div', { 
          className: 'settings-toggle',
          onClick: () => setShowSettings(!showSettings)
        }, showSettings ? '‚ñº' : '‚ñ∂', ' API Settings'),
        showSettings && React.createElement('div', { className: 'settings-panel' },
          React.createElement('input', {
            type: 'password',
            placeholder: 'Enter Anthropic API Key',
            value: apiKey,
            onChange: (e) => setApiKey(e.target.value)
          })
        )
      ),
      
      // Upload
      React.createElement('div', { className: 'section' },
        React.createElement('div', { className: 'section-title' }, 'üìÅ Upload Policy Document'),
        React.createElement('div', {
          className: `upload-zone ${file ? 'has-file' : ''}`,
          onClick: () => document.getElementById('file-input').click(),
          onDragOver: (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); },
          onDragLeave: (e) => e.currentTarget.classList.remove('dragover'),
          onDrop: (e) => { e.preventDefault(); e.currentTarget.classList.remove('dragover'); if (e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]); }
        },
          React.createElement('div', { className: 'upload-icon' }, file ? '‚úÖ' : 'üìÑ'),
          React.createElement('div', { className: 'upload-text' },
            file ? React.createElement('strong', null, file.name) : React.createElement(React.Fragment, null, 'Drop file here or ', React.createElement('strong', null, 'click to browse'))
          ),
          !file && React.createElement('div', { className: 'upload-text', style: { marginTop: '5px' } }, 'Supports .docx, .pdf, .txt')
        ),
        React.createElement('input', { id: 'file-input', type: 'file', accept: '.txt,.docx,.pdf', style: { display: 'none' }, onChange: (e) => e.target.files[0] && readFile(e.target.files[0]) }),
        
        // File info table
        fileInfo && React.createElement('table', { className: 'file-table' },
          React.createElement('thead', null,
            React.createElement('tr', null,
              React.createElement('th', null, 'File Name'),
              React.createElement('th', null, 'Type'),
              React.createElement('th', null, 'Size'),
              React.createElement('th', null, 'Characters'),
              React.createElement('th', null, 'Words')
            )
          ),
          React.createElement('tbody', null,
            React.createElement('tr', null,
              React.createElement('td', null, fileInfo.name),
              React.createElement('td', null, fileInfo.type),
              React.createElement('td', null, fileInfo.size),
              React.createElement('td', null, fileInfo.chars),
              React.createElement('td', null, fileInfo.words)
            )
          )
        )
      ),
      
      // TAB CONTENT
      activeTab === 'review' ? (
        // ‚ïê‚ïê‚ïê REVIEW TAB ‚ïê‚ïê‚ïê
        React.createElement(React.Fragment, null,
          React.createElement('div', { className: 'section' },
            React.createElement('div', { className: 'section-title' }, 'üìã Policy Type'),
            React.createElement('select', { value: policyType, onChange: (e) => setPolicyType(e.target.value) },
              Object.entries(POLICY_PRESETS).map(([key, val]) => 
                React.createElement('option', { key, value: key }, val.name)
              )
            ),
            React.createElement('div', { className: 'btn-group' },
              React.createElement('button', {
                className: 'btn btn-primary',
                disabled: !file || !apiKey || loading,
                onClick: runReview
              }, loading ? React.createElement('span', { className: 'spinner' }) : 'üîç', loading ? ' Analysing...' : ' Run Compliance Review')
            )
          ),
          
          // Review Results
          reviewResults && React.createElement('div', { className: 'section' },
            React.createElement('div', { className: 'section-title' }, 'üìä Review Results'),
            React.createElement('div', { className: 'results-box' },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '20px' } },
                React.createElement('div', null,
                  React.createElement('div', { className: 'score' }, reviewResults.overallScore + '%'),
                  React.createElement('div', { className: 'score-label' }, 'Compliance Score')
                ),
                React.createElement('div', { className: 'summary' }, reviewResults.summary)
              )
            ),
            
            // Template checks
            React.createElement('div', { style: { marginTop: '20px' } },
              React.createElement('div', { className: 'section-title' }, '‚úì Template Compliance'),
              (reviewResults.templateChecks || []).map((check, i) => 
                React.createElement('div', { key: i, className: 'check-item' },
                  React.createElement('span', { className: `check-icon ${check.pass ? 'check-pass' : 'check-fail'}` }, check.pass ? '‚úì' : '‚úó'),
                  React.createElement('div', null,
                    React.createElement('div', { className: 'check-label' }, TASIS_TEMPLATE_CHECKS.find(t => t.id === check.id)?.label || check.id),
                    check.note && React.createElement('div', { className: 'check-note' }, check.note)
                  )
                )
              )
            ),
            
            // Issues
            (reviewResults.contentIssues?.length > 0) && React.createElement('div', { style: { marginTop: '20px' } },
              React.createElement('div', { className: 'section-title' }, '‚ö†Ô∏è Issues Found'),
              reviewResults.contentIssues.map((issue, i) => 
                React.createElement('div', { key: i, className: `issue issue-${issue.type}` },
                  React.createElement('div', { className: 'issue-title' }, issue.issue),
                  React.createElement('div', { className: 'issue-suggestion' }, '‚Üí ', issue.suggestion)
                )
              )
            ),
            
            // Priority actions
            (reviewResults.priorityActions?.length > 0) && React.createElement('div', { style: { marginTop: '20px' } },
              React.createElement('div', { className: 'section-title' }, 'üéØ Priority Actions'),
              reviewResults.priorityActions.map((action, i) => 
                React.createElement('div', { key: i, className: 'priority-item' },
                  React.createElement('span', { className: 'priority-num' }, i + 1),
                  React.createElement('span', { className: 'priority-text' }, action)
                )
              )
            )
          )
        )
      ) : (
        // ‚ïê‚ïê‚ïê FORMAT TAB ‚ïê‚ïê‚ïê
        React.createElement(React.Fragment, null,
          React.createElement('div', { className: 'section' },
            React.createElement('div', { className: 'section-title' }, 'üìÑ Format to TASIS Template'),
            React.createElement('p', { style: { fontSize: '13px', color: '#64748B', marginBottom: '15px' } },
              'This tool structures your policy into the TASIS template format. ',
              React.createElement('strong', null, 'Content is preserved exactly as written'),
              ' ‚Äî only the layout changes.'
            ),
            
            // Raw text preview
            fileText && React.createElement('div', { style: { marginBottom: '15px' } },
              React.createElement('details', null,
                React.createElement('summary', { style: { cursor: 'pointer', fontSize: '12px', color: '#64748B' } }, 
                  'üëÅÔ∏è Preview extracted text (', (fileText.match(/\n/g) || []).length, ' line breaks detected)'
                ),
                React.createElement('pre', { 
                  style: { 
                    background: '#f8fafc', 
                    padding: '10px', 
                    fontSize: '10px', 
                    maxHeight: '200px', 
                    overflow: 'auto', 
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word',
                    border: '1px solid #e2e8f0',
                    borderRadius: '6px',
                    marginTop: '8px'
                  } 
                }, fileText.substring(0, 3000) + (fileText.length > 3000 ? '\n\n... [truncated]' : ''))
              )
            ),
            
            React.createElement('div', { className: 'btn-group' },
              React.createElement('button', {
                className: 'btn btn-primary',
                disabled: !file || !apiKey || loading,
                onClick: runFormat
              }, loading ? React.createElement('span', { className: 'spinner' }) : '‚öôÔ∏è', loading ? ' Processing...' : ' Extract Metadata & Format'),
              React.createElement('button', {
                className: 'btn',
                style: { background: '#64748B', color: 'white' },
                disabled: !file || loading,
                onClick: () => quickFormat()
              }, '‚ö° Quick Format (No AI)')
            ),
            React.createElement('p', { style: { fontSize: '11px', color: '#94A3B8', marginTop: '8px' } },
              'Quick Format skips metadata extraction and just wraps your content in the TASIS template.'
            )
          ),
          
          // Format Results
          formatResults && React.createElement('div', { className: 'section' },
            React.createElement('div', { className: 'section-title' }, '‚úÖ Formatted Policy Ready'),
            
            // Metadata preview
            React.createElement('div', { className: 'preview-section' },
              React.createElement('div', { className: 'preview-title' }, 'Extracted Metadata'),
              React.createElement('table', { className: 'file-table' },
                React.createElement('tbody', null,
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600, width: '140px' } }, 'Title'), React.createElement('td', null, formatResults.policyTitle)),
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600 } }, 'Short Code'), React.createElement('td', null, formatResults.shortCode)),
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600 } }, 'Version'), React.createElement('td', null, formatResults.version)),
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600 } }, 'Published'), React.createElement('td', null, formatResults.datePublished || '‚Äî')),
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600 } }, 'Review Date'), React.createElement('td', null, formatResults.reviewDate || '‚Äî')),
                  React.createElement('tr', null, React.createElement('td', { style: { fontWeight: 600 } }, 'Owner'), React.createElement('td', null, formatResults.responsibleArea || '‚Äî'))
                )
              )
            ),
            
            // Content info
            React.createElement('div', { className: 'preview-section', style: { marginTop: '15px' } },
              React.createElement('div', { className: 'preview-title' }, 'Document Structure'),
              React.createElement('p', { style: { fontSize: '13px', color: '#374151' } },
                formatResults.hasStructure 
                  ? '‚úÖ Original document structure preserved (headings, lists, tables)'
                  : 'üìù Plain text converted to paragraphs'
              ),
              React.createElement('p', { style: { fontSize: '12px', color: '#64748B', marginTop: '5px' } },
                `Content: ${formatResults.originalLength.toLocaleString()} characters`
              )
            ),
            
            // Download button
            React.createElement('div', { className: 'btn-group', style: { marginTop: '20px' } },
              React.createElement('button', { className: 'btn btn-success', onClick: downloadHTML },
                'üì• Download Formatted Policy (HTML)'
              )
            ),
            React.createElement('p', { style: { fontSize: '11px', color: '#94A3B8', marginTop: '10px' } },
              'Open the HTML file and use Print ‚Üí Save as PDF for a professional document.'
            )
          )
        )
      )
    ),
    
    // Footer
    React.createElement('div', { className: 'footer' }, '¬© 2026 TASIS England ‚Ä¢ Policy Tools')
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(PolicyTools));
  </script>
</body>
</html>
